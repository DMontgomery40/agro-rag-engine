#!/usr/bin/env bash
set -euo pipefail

# Resolve repo root relative to this script
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

usage() {
  cat <<'USAGE'
Usage: ragctl <command> [args]

Infrastructure:
  up                 Start Qdrant + Redis (docker compose)
  down               Stop infra
  status             Show Infra status (Docker/Ports)
  api                Run FastAPI server on 127.0.0.1:8012
  setup [PATH]       Run guided setup

App Commands (requires API running):
  chat               Start interactive chat
  index <REPO>       Index a repository
  config             Show/Set configuration
  eval               Run evaluations
  reranker           Reranker operations
  profiles           Manage profiles

Environment:
  REPOS_FILE   Override path to repos.json
  REPO         Default repo
USAGE
}

cmd="${1:-}"
if [ -z "$cmd" ]; then
  usage
  exit 0
fi
shift || true

# Infra commands
case "$cmd" in
  up)
    exec bash "$ROOT_DIR/scripts/up.sh"
    ;;
  down)
    exec bash "$ROOT_DIR/scripts/down.sh"
    ;;
  status)
    exec bash "$ROOT_DIR/scripts/status.sh"
    ;;
  setup)
    exec bash "$ROOT_DIR/scripts/setup.sh" "${1:-}" "${2:-}"
    ;;
  api)
    if [ -x "$ROOT_DIR/.venv/bin/python" ]; then
      . "$ROOT_DIR/.venv/bin/activate"
    fi
    exec python -m uvicorn server.asgi:create_app --factory --host 127.0.0.1 --port 8012
    ;;
  mcp-list)
     if [ -x "$ROOT_DIR/.venv/bin/python" ]; then
      . "$ROOT_DIR/.venv/bin/activate"
    fi
    printf '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}\n' | python -m server.mcp.server
    ;;
  # App commands -> Delegate to Python CLI
  chat|index|config|config-set|eval|eval-status|reranker|profiles|profile-apply)
    if [ -x "$ROOT_DIR/.venv/bin/python" ]; then
      . "$ROOT_DIR/.venv/bin/activate"
    fi
    # Pass the command and all arguments
    exec python -m cli.agro "$cmd" "$@"
    ;;
  help|h|-h|--help)
    usage; exit 0 ;;
  *)
    echo "Unknown command: $cmd" >&2
    usage; exit 2 ;;
esac
