<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-development/architecture" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Architecture | AGRO Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://dmontgomery40.github.io/agro-rag-engine/img/agro-social.png"><meta data-rh="true" name="twitter:image" content="https://dmontgomery40.github.io/agro-rag-engine/img/agro-social.png"><meta data-rh="true" property="og:url" content="https://dmontgomery40.github.io/agro-rag-engine/development/architecture"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Architecture | AGRO Documentation"><meta data-rh="true" name="description" content="AGRO is a production-grade RAG system with a modular architecture designed for code retrieval. This page explains the system components, data flow, and key design decisions."><meta data-rh="true" property="og:description" content="AGRO is a production-grade RAG system with a modular architecture designed for code retrieval. This page explains the system components, data flow, and key design decisions."><link data-rh="true" rel="icon" href="/agro-rag-engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://dmontgomery40.github.io/agro-rag-engine/development/architecture"><link data-rh="true" rel="alternate" href="https://dmontgomery40.github.io/agro-rag-engine/development/architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://dmontgomery40.github.io/agro-rag-engine/development/architecture" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://YOUR_APP_ID-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Architecture","item":"https://dmontgomery40.github.io/agro-rag-engine/development/architecture"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="AGRO Documentation" href="/agro-rag-engine/opensearch.xml"><link rel="stylesheet" href="/agro-rag-engine/assets/css/styles.1a1fe8cb.css">
<script src="/agro-rag-engine/assets/js/runtime~main.34578a38.js" defer="defer"></script>
<script src="/agro-rag-engine/assets/js/main.58efc273.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/agro-rag-engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/agro-rag-engine/"><div class="navbar__logo"><img src="/agro-rag-engine/img/logo.svg" alt="AGRO Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/agro-rag-engine/img/logo.svg" alt="AGRO Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AGRO</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/agro-rag-engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/DMontgomery40/agro-rag-engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Meta+k)" aria-keyshortcuts="Meta+k"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="8" stroke="currentColor" fill="none" stroke-width="1.4"></circle><path d="m21 21-4.3-4.3" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/agro-rag-engine/"><span title="Introduction" class="linkLabel_WmDU">Introduction</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/agro-rag-engine/getting-started/quickstart"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/agro-rag-engine/getting-started/quickstart"><span title="Quick Start" class="linkLabel_WmDU">Quick Start</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/agro-rag-engine/getting-started/installation"><span title="Installation" class="linkLabel_WmDU">Installation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/agro-rag-engine/getting-started/first-steps"><span title="First Steps" class="linkLabel_WmDU">First Steps</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/agro-rag-engine/features/rag"><span title="Core Features" class="categoryLinkLabel_W154">Core Features</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/agro-rag-engine/api/reference"><span title="API Reference" class="categoryLinkLabel_W154">API Reference</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/agro-rag-engine/configuration/models"><span title="Configuration" class="categoryLinkLabel_W154">Configuration</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/agro-rag-engine/development/contributing"><span title="Development" class="categoryLinkLabel_W154">Development</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/agro-rag-engine/development/contributing"><span title="Contributing" class="linkLabel_WmDU">Contributing</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/agro-rag-engine/development/vscode-setup"><span title="VS Code Setup" class="linkLabel_WmDU">VS Code Setup</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/agro-rag-engine/development/architecture"><span title="Architecture" class="linkLabel_WmDU">Architecture</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/agro-rag-engine/operations/deployment"><span title="Operations" class="categoryLinkLabel_W154">Operations</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/agro-rag-engine/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Development</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Architecture</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Architecture</h1></header>
<p>AGRO is a production-grade RAG system with a modular architecture designed for code retrieval. This page explains the system components, data flow, and key design decisions.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="system-overview">System Overview<a href="#system-overview" class="hash-link" aria-label="Direct link to System Overview" title="Direct link to System Overview" translate="no">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│                         AGRO Architecture                        │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└─────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌──────────────┐      ┌──────────────┐      ┌──────────────┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ Claude Code  │      │   Web GUI    │      │  CLI Chat    │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   (STDIO)    │      │   (HTTP)     │      │   (Local)    │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└──────┬───────┘      └──────┬───────┘      └──────┬───────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">       │                     │                     │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">       └─────────────────────┼─────────────────────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                             │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                ┌────────────▼────────────┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                │    FastAPI Server       │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                │    (port 8012)          │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                └────────────┬────────────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                             │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        ┌────────────────────┼────────────────────┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        │                    │                    │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   ┌────▼─────┐    ┌─────────▼────────┐   ┌──────▼──────┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   │ LangGraph│    │  Hybrid Search   │   │  Indexer    │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   │ Pipeline │    │  (BM25 + Vector) │   │  (AST)      │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   └────┬─────┘    └─────────┬────────┘   └──────┬──────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        │                    │                    │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        │         ┌──────────┼──────────┐        │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        │         │          │          │        │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   ┌────▼────┐ ┌──▼───┐ ┌────▼────┐ ┌───▼────┐  │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   │  Redis  │ │BM25S │ │ Qdrant  │ │Cohere  │  │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   │Checkpts │ │Index │ │ Vectors │ │Rerank  │  │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   └─────────┘ └──────┘ └─────────┘ └────────┘  │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                                  │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        ┌─────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   ┌────▼────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   │  Observability Stack                    │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   │  ┌──────────┐  ┌──────────┐  ┌────────┐│</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   │  │Prometheus│  │ Grafana  │  │LangSmth││</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   │  └──────────┘  └──────────┘  └────────┘│</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   └─────────────────────────────────────────┘</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="core-components">Core Components<a href="#core-components" class="hash-link" aria-label="Direct link to Core Components" title="Direct link to Core Components" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-fastapi-server-serverapppy">1. FastAPI Server (<code>server/app.py</code>)<a href="#1-fastapi-server-serverapppy" class="hash-link" aria-label="Direct link to 1-fastapi-server-serverapppy" title="Direct link to 1-fastapi-server-serverapppy" translate="no">​</a></h3>
<p><strong>Role:</strong> HTTP API gateway for all AGRO operations</p>
<p><strong>Key endpoints:</strong></p>
<ul>
<li class=""><code>/answer</code> - LangGraph RAG pipeline (retrieval + generation + citations)</li>
<li class=""><code>/search</code> - Hybrid search only (no LLM generation)</li>
<li class=""><code>/api/chat</code> - Stateful conversation with Redis checkpoints</li>
<li class=""><code>/api/index/*</code> - Indexing operations</li>
<li class=""><code>/api/golden/*</code> - Golden test management</li>
<li class=""><code>/api/reranker/*</code> - Reranker training pipeline</li>
<li class=""><code>/api/docker/*</code> - Infrastructure management</li>
<li class=""><code>/metrics</code> - Prometheus metrics</li>
</ul>
<p><strong>Technology:</strong></p>
<ul>
<li class="">FastAPI 0.115+ (async, Pydantic validation)</li>
<li class="">Uvicorn ASGI server</li>
<li class="">Prometheus client for metrics</li>
<li class="">LangTrace for OpenTelemetry tracing</li>
</ul>
<p><strong>File location:</strong> <code>/Users/davidmontgomery/agro-rag-engine/server/app.py</code></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-langgraph-pipeline-serverlanggraph_apppy">2. LangGraph Pipeline (<code>server/langgraph_app.py</code>)<a href="#2-langgraph-pipeline-serverlanggraph_apppy" class="hash-link" aria-label="Direct link to 2-langgraph-pipeline-serverlanggraph_apppy" title="Direct link to 2-langgraph-pipeline-serverlanggraph_apppy" translate="no">​</a></h3>
<p><strong>Role:</strong> Stateful RAG workflow with conditional routing</p>
<p><strong>State machine:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">RAGState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">TypedDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    question</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Annotated</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">List</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> operator</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    generation</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    iteration</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    confidence</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    repo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><br></span></code></pre></div></div>
<p><strong>Flow:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">Entry → retrieve_node</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">         ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     route_after_retrieval (confidence gating)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">         ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ┌────┴────┬─────────────┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    │         │             │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">generate   rewrite    fallback</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    │      query          │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ↓         ↓           ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   END    retrieve      END</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            (retry)</span><br></span></code></pre></div></div>
<p><strong>Confidence gating thresholds:</strong></p>
<ul>
<li class=""><code>CONF_TOP1</code>: 0.62 (top result rerank score)</li>
<li class=""><code>CONF_AVG5</code>: 0.55 (average of top 5)</li>
<li class=""><code>CONF_ANY</code>: 0.55 (overall confidence)</li>
</ul>
<p>If confidence is too low after 3 iterations, fallback message returned.</p>
<p><strong>Redis checkpoints:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">checkpointer </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> RedisSaver</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">redis_url</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;redis://127.0.0.1:6379/0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">graph </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> builder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">compile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">checkpointer</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">checkpointer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<p>Enables stateful conversation with memory per <code>thread_id</code>.</p>
<p><strong>File location:</strong> <code>/Users/davidmontgomery/agro-rag-engine/server/langgraph_app.py</code></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-hybrid-search-engine-retrievalhybrid_searchpy">3. Hybrid Search Engine (<code>retrieval/hybrid_search.py</code>)<a href="#3-hybrid-search-engine-retrievalhybrid_searchpy" class="hash-link" aria-label="Direct link to 3-hybrid-search-engine-retrievalhybrid_searchpy" title="Direct link to 3-hybrid-search-engine-retrievalhybrid_searchpy" translate="no">​</a></h3>
<p><strong>Role:</strong> Multi-stage retrieval combining BM25, dense vectors, and semantic cards</p>
<p><strong>Pipeline stages:</strong></p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="stage-1-multi-query-expansion">Stage 1: Multi-Query Expansion<a href="#stage-1-multi-query-expansion" class="hash-link" aria-label="Direct link to Stage 1: Multi-Query Expansion" title="Direct link to Stage 1: Multi-Query Expansion" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">expand_queries</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> List</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Generate m search-optimized query variants via LLM.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Original query + (m-1) LLM-rewritten variants</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Expands CamelCase, includes API nouns, removes stop words</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="stage-2-parallel-retrieval">Stage 2: Parallel Retrieval<a href="#stage-2-parallel-retrieval" class="hash-link" aria-label="Direct link to Stage 2: Parallel Retrieval" title="Direct link to Stage 2: Parallel Retrieval" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># BM25 sparse search</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">bm25_retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Retrieve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data/agro/bm25_index&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">sparse_results </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> bm25_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrieve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tokens</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> k</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">75</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Dense vector search (Qdrant)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">qclient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">query_points</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    collection_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;code_chunks_agro&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">embedding</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    limit</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">75</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Semantic cards (conceptual matches)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">card_bm25</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrieve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query_tokens</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> k</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">20</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="stage-3-reciprocal-rank-fusion-rrf">Stage 3: Reciprocal Rank Fusion (RRF)<a href="#stage-3-reciprocal-rank-fusion-rrf" class="hash-link" aria-label="Direct link to Stage 3: Reciprocal Rank Fusion (RRF)" title="Direct link to Stage 3: Reciprocal Rank Fusion (RRF)" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">rrf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">dense</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> sparse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> kdiv</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">60</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    score </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> defaultdict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> rank</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> chunk_id </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">enumerate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">dense</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> start</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        score</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">chunk_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1.0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">kdiv </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> rank</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> rank</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> chunk_id </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">enumerate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sparse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> start</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        score</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">chunk_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1.0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">kdiv </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> rank</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">sorted</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">score</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> reverse</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain">k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><br></span></code></pre></div></div>
<p>No score normalization needed—rank-based fusion is robust.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="stage-4-cross-encoder-reranking">Stage 4: Cross-Encoder Reranking<a href="#stage-4-cross-encoder-reranking" class="hash-link" aria-label="Direct link to Stage 4: Cross-Encoder Reranking" title="Direct link to Stage 4: Cross-Encoder Reranking" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Local reranker (default)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> CrossEncoder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;cross-encoder/ms-marco-MiniLM-L-6-v2&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">scores </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;code&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> docs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Or Cohere Rerank API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">cohere</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">rerank</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> documents</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;code&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> d </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> docs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="stage-5-contextual-bonuses">Stage 5: Contextual Bonuses<a href="#stage-5-contextual-bonuses" class="hash-link" aria-label="Direct link to Stage 5: Contextual Bonuses" title="Direct link to Stage 5: Contextual Bonuses" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Path boost (+0.06 for prioritized directories)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">any</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;file_path&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> p </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> path_boosts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;score&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.06</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Layer bonus (intent-based, e.g., &quot;gui&quot; query → gui/ files +0.15)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> query_intent </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;gui&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;gui/&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;file_path&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;score&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Card hit bonus (+0.08 if matched via semantic card)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;id&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> card_chunk_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;score&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.08</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Language bonus (code vs docs)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> wants_code </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;language&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;python&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;javascript&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;score&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.50</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="stage-6-local-hydration">Stage 6: Local Hydration<a href="#stage-6-local-hydration" class="hash-link" aria-label="Direct link to Stage 6: Local Hydration" title="Direct link to Stage 6: Local Hydration" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_hydrate_docs_inplace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">repo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> docs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Load full code from chunks.jsonl (lazy loading).&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&#x27;data/</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">repo</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">/chunks.jsonl&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> line </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            chunk </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">line</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;id&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> needed_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                docs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;code&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;code&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:rgb(181, 206, 168)">2000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><br></span></code></pre></div></div>
<p>Qdrant payloads don&#x27;t include full code (saves memory). Hydration happens after reranking for top-K only.</p>
<p><strong>File location:</strong> <code>/Users/davidmontgomery/agro-rag-engine/retrieval/hybrid_search.py</code></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-ast-aware-indexer-retrievalast_chunkerpy">4. AST-Aware Indexer (<code>retrieval/ast_chunker.py</code>)<a href="#4-ast-aware-indexer-retrievalast_chunkerpy" class="hash-link" aria-label="Direct link to 4-ast-aware-indexer-retrievalast_chunkerpy" title="Direct link to 4-ast-aware-indexer-retrievalast_chunkerpy" translate="no">​</a></h3>
<p><strong>Role:</strong> Parse code into semantically meaningful chunks</p>
<p><strong>Supported languages:</strong></p>
<ul>
<li class="">Python, JavaScript, TypeScript, Go, Java, Rust, C, C++, Bash</li>
</ul>
<p><strong>Chunking strategy:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">chunk_code</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">src</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> fpath</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> lang</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">900</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> List</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    AST-aware chunking with overlap.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    - Uses tree-sitter to parse AST</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    - Extracts functions, classes, methods</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    - Adds imports to each chunk (context)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    - Falls back to greedy chunking if AST fails</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    &quot;&quot;&quot;</span><br></span></code></pre></div></div>
<p><strong>Example chunk:</strong></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token property">&quot;id&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;abc123&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token property">&quot;file_path&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;server/app.py&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token property">&quot;start_line&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token property">&quot;end_line&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">120</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token property">&quot;language&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;python&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;function&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;health&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token property">&quot;imports&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;from fastapi import FastAPI&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ...</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token property">&quot;code&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;def health():\n    ...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre></div></div>
<p><strong>Overlap:</strong> 20 lines between chunks to preserve context.</p>
<p><strong>File location:</strong> <code>/Users/davidmontgomery/agro-rag-engine/retrieval/ast_chunker.py</code></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-vector-database-qdrant">5. Vector Database (Qdrant)<a href="#5-vector-database-qdrant" class="hash-link" aria-label="Direct link to 5. Vector Database (Qdrant)" title="Direct link to 5. Vector Database (Qdrant)" translate="no">​</a></h3>
<p><strong>Role:</strong> Store and search dense embeddings</p>
<p><strong>Docker service:</strong></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token key atrule">qdrant</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> qdrant/qdrant</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain">v1.15.5</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;6333:6333&quot;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># HTTP API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;6334:6334&quot;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># gRPC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> ../data/qdrant</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain">/qdrant/storage</span><br></span></code></pre></div></div>
<p><strong>Collection structure:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vectors&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;size&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1536</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># OpenAI text-embedding-3-large</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;distance&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Cosine&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;payload_schema&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;file_path&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;keyword&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;language&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;keyword&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;layer&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;keyword&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;repo&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;keyword&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;start_line&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;integer&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;end_line&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;integer&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre></div></div>
<p><strong>Why not store code in payload?</strong></p>
<ul>
<li class="">Keeps memory usage low (only metadata + vector)</li>
<li class="">Code loaded lazily from <code>chunks.jsonl</code> after reranking</li>
<li class="">Enables larger indexes with same RAM</li>
</ul>
<p><strong>File location:</strong> <code>/Users/davidmontgomery/agro-rag-engine/infra/docker-compose.yml</code></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-bm25-sparse-index-bm25s">6. BM25 Sparse Index (<code>bm25s</code>)<a href="#6-bm25-sparse-index-bm25s" class="hash-link" aria-label="Direct link to 6-bm25-sparse-index-bm25s" title="Direct link to 6-bm25-sparse-index-bm25s" translate="no">​</a></h3>
<p><strong>Role:</strong> Keyword-based retrieval with stemming</p>
<p><strong>Index creation:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> bm25s </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> BM25</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Tokenizer</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> Stemmer </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Stemmer</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">tokenizer </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">stemmer</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">Stemmer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;english&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> stopwords</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;en&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">corpus_tokens </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tokenize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">corpus</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> BM25</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">corpus_tokens</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">save</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data/agro/bm25_index&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<p><strong>Search:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">query_tokens </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tokenize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> scores </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrieve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query_tokens</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> k</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">75</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<p><strong>Why BM25 matters for code:</strong></p>
<ul>
<li class="">Exact matches for function names, class names, API endpoints</li>
<li class="">Handles acronyms, camelCase, snake_case better than embeddings</li>
<li class="">Language-agnostic (no training needed)</li>
</ul>
<p><strong>File location:</strong> BM25 logic in <code>/Users/davidmontgomery/agro-rag-engine/retrieval/hybrid_search.py</code></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-self-learning-reranker">7. Self-Learning Reranker<a href="#7-self-learning-reranker" class="hash-link" aria-label="Direct link to 7. Self-Learning Reranker" title="Direct link to 7. Self-Learning Reranker" translate="no">​</a></h3>
<p><strong>Role:</strong> Train custom cross-encoder on your codebase</p>
<p><strong>Pipeline:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">User Feedback → Triplet Mining → Model Training → Eval → Auto-Promotion</span><br></span></code></pre></div></div>
<p><strong>1. Feedback collection:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Click tracking (implicit)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">POST </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">api</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">reranker</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">click </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;query_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;...&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;doc_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;...&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;rank&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Star ratings (explicit)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">POST </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">api</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">feedback </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;event_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;...&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;signal&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;star5&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre></div></div>
<p><strong>2. Triplet mining:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># From query logs (queries.jsonl)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Positive: clicked/high-rated docs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Negative: docs ranked below positive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">triplets </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;query&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;positive_doc&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;negative_doc&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><br></span></code></pre></div></div>
<p><strong>3. Training:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> sentence_transformers </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> CrossEncoder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> InputExample</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> sentence_transformers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cross_encoder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">evaluation </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> CERerankingEvaluator</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> CrossEncoder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;cross-encoder/ms-marco-MiniLM-L-6-v2&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">train_samples </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    InputExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">texts</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> pos</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> label</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1.0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    InputExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">texts</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> neg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> label</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0.0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    train_dataloader</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">DataLoader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">train_samples</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> batch_size</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">16</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    epochs</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    warmup_steps</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">save</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;models/cross-encoder-agro&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<p><strong>4. Evaluation:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Run on golden questions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mrr_baseline </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.72</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Baseline MRR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mrr_reranker </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.88</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Custom reranker MRR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> mrr_reranker </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> mrr_baseline </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1.05</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Auto-promote (hot-reload, no server restart)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    promote_reranker</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<p><strong>File locations:</strong></p>
<ul>
<li class="">Training logic: <code>/Users/davidmontgomery/agro-rag-engine/server/app.py</code> (<code>/api/reranker/train</code>)</li>
<li class="">Triplet mining: <code>/api/reranker/mine</code></li>
<li class="">Model storage: <code>/Users/davidmontgomery/agro-rag-engine/models/cross-encoder-agro/</code></li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="8-semantic-cards">8. Semantic Cards<a href="#8-semantic-cards" class="hash-link" aria-label="Direct link to 8. Semantic Cards" title="Direct link to 8. Semantic Cards" translate="no">​</a></h3>
<p><strong>Role:</strong> High-level summaries for conceptual matches</p>
<p><strong>Generation:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># For each chunk, generate summary card via LLM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">card </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> generate_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    user_input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Summarize this code in one sentence:\n\n</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">chunk</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-interpolation interpolation string" style="color:rgb(206, 145, 120)">&#x27;code&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    system_instructions</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;You summarize code at a high level.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Store in cards.jsonl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;chunk_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;abc123&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;card&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;REST API endpoint for answering questions...&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre></div></div>
<p><strong>Indexing:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Build separate BM25 index for cards</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">card_corpus </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">card</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;card&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> card </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> cards</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">card_bm25 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> BM25</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">card_bm25</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tokenize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">card_corpus</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">card_bm25</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">save</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data/agro/bm25_cards&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre></div></div>
<p><strong>Retrieval:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Search card index</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">card_hits </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> card_bm25</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrieve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query_tokens</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> k</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">20</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Get chunk IDs from matching cards</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">card_chunk_ids </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">cards</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">hit_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;chunk_id&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> hit_id </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> card_hits</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Boost these chunks in final ranking (+0.08)</span><br></span></code></pre></div></div>
<p><strong>Why cards?</strong></p>
<ul>
<li class="">Capture intent even when code uses different terminology</li>
<li class="">Enable &quot;fuzzy&quot; conceptual matches</li>
<li class="">Improve recall for high-level queries</li>
</ul>
<p><strong>File location:</strong> Card builder in <code>/Users/davidmontgomery/agro-rag-engine/server/cards_builder.py</code></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="9-mcp-servers">9. MCP Servers<a href="#9-mcp-servers" class="hash-link" aria-label="Direct link to 9. MCP Servers" title="Direct link to 9. MCP Servers" translate="no">​</a></h3>
<p><strong>Role:</strong> Multi-transport access to RAG (STDIO, HTTP, SSE, WebSocket)</p>
<p><strong>STDIO (for Claude Code/Codex):</strong></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token property">&quot;mcpServers&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token property">&quot;agro&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token property">&quot;command&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;python&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token property">&quot;args&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;/path/to/agro/mcp/stdio_server.py&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token property">&quot;env&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token property">&quot;REPO&quot;</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;agro&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre></div></div>
<p><strong>HTTP (for remote agents):</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Start server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python mcp/http_server.py </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--port</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">8013</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Call from agent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-X</span><span class="token plain"> POST http://127.0.0.1:8013/tools/rag_search </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-H</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Content-Type: application/json&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-d</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;{&quot;query&quot;: &quot;How does indexing work?&quot;, &quot;repo&quot;: &quot;agro&quot;}&#x27;</span><br></span></code></pre></div></div>
<p><strong>Tools exposed:</strong></p>
<ul>
<li class=""><code>rag_answer</code>: Full RAG pipeline (retrieval + generation + citations)</li>
<li class=""><code>rag_search</code>: Retrieval only (no LLM)</li>
<li class=""><code>netlify_deploy</code>: Deploy docs to Netlify</li>
<li class=""><code>web_get</code>: Fetch web content</li>
</ul>
<p><strong>Per-transport config:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># STDIO uses local model (free)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">STDIO_GENERATION_MODEL</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">qwen3</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">coder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain">30b</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># HTTP uses cloud model (cheap)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">HTTP_GENERATION_MODEL</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">gpt</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">4o</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">mini</span><br></span></code></pre></div></div>
<p><strong>File locations:</strong></p>
<ul>
<li class="">STDIO: <code>/Users/davidmontgomery/agro-rag-engine/mcp/stdio_server.py</code></li>
<li class="">HTTP: <code>/Users/davidmontgomery/agro-rag-engine/mcp/http_server.py</code></li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="10-observability-stack">10. Observability Stack<a href="#10-observability-stack" class="hash-link" aria-label="Direct link to 10. Observability Stack" title="Direct link to 10. Observability Stack" translate="no">​</a></h3>
<p><strong>Prometheus metrics:</strong></p>
<div class="language-prometheus codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-prometheus codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain"># Request counts</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">agro_requests_total{route=&quot;/answer&quot;, model=&quot;gpt-4o&quot;, success=&quot;true&quot;}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"># Latency histograms</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">agro_request_duration_seconds{stage=&quot;retrieve&quot;}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">agro_request_duration_seconds{stage=&quot;rerank&quot;}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"># Token usage</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">agro_tokens_total{role=&quot;prompt&quot;, provider=&quot;openai&quot;, model=&quot;gpt-4o&quot;}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"># Retrieval quality</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">agro_rr_mrr  # Mean reciprocal rank</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">agro_retrieval_hits{topk=&quot;10&quot;}</span><br></span></code></pre></div></div>
<p><strong>Grafana dashboards:</strong></p>
<ul>
<li class="">Request rates and latency (P50, P95, P99)</li>
<li class="">Error rates and alert status</li>
<li class="">Token usage and cost estimation</li>
<li class="">Retrieval quality (MRR, Hit@K)</li>
</ul>
<p><strong>LangSmith tracing:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Automatic tracing (via LangTrace)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># View at https://smith.langchain.com/public/{trace_id}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Embedded in GUI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">GET </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">api</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">langsmith</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">latest → share URL</span><br></span></code></pre></div></div>
<p><strong>Docker services:</strong></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token key atrule">prometheus</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> prom/prometheus</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;9090:9090&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> ./prometheus.yml</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain">/etc/prometheus/prometheus.yml</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">grafana</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> grafana/grafana</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;3000:3000&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> GF_SECURITY_ALLOW_EMBEDDING=true  </span><span class="token comment" style="color:rgb(106, 153, 85)"># For GUI iframe</span><br></span></code></pre></div></div>
<p><strong>File location:</strong> <code>/Users/davidmontgomery/agro-rag-engine/infra/docker-compose.yml</code></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="data-flow">Data Flow<a href="#data-flow" class="hash-link" aria-label="Direct link to Data Flow" title="Direct link to Data Flow" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="indexing-pipeline">Indexing Pipeline<a href="#indexing-pipeline" class="hash-link" aria-label="Direct link to Indexing Pipeline" title="Direct link to Indexing Pipeline" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">Source Code (Python, JS, TS, Go, etc.)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">AST Chunker (tree-sitter parsing)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Chunks (functions, classes with imports)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Parallel Processing:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ BM25 Index (stemmed tokens)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ Dense Vectors (OpenAI/Voyage/Local embeddings)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  └─ Semantic Cards (LLM-generated summaries)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Storage:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ data/{repo}/chunks.jsonl (full code)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ data/{repo}/bm25_index/ (BM25S)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ data/{repo}/bm25_cards/ (Card BM25)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  └─ Qdrant collection (vectors + metadata)</span><br></span></code></pre></div></div>
<p><strong>Time:</strong> 10-20 minutes for ~5000 chunks (depends on embedding provider).</p>
<p><strong>Cost:</strong> $1-5 for embeddings + card generation (cloud models).</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="query-pipeline">Query Pipeline<a href="#query-pipeline" class="hash-link" aria-label="Direct link to Query Pipeline" title="Direct link to Query Pipeline" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">User Query (&quot;How does hybrid search work?&quot;)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Multi-Query Expansion (LLM)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ &quot;How does hybrid search work?&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ &quot;hybrid search implementation&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ &quot;BM25 and vector fusion algorithm&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  └─ &quot;retrieval pipeline code&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Parallel Retrieval (for each variant):</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ BM25 Search (top 75)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ Dense Vector Search (top 75)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  └─ Semantic Card Search (top 20)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Reciprocal Rank Fusion (RRF)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Cross-Encoder Reranking (top 100 → scored)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Contextual Bonuses (path, layer, language, cards)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Local Hydration (load full code for top K)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">LangGraph Confidence Gating</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ High confidence (≥0.62) → Generate answer</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ├─ Low confidence (\&lt;0.5lt;0.55) → Rewrite query and retry</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  └─ Still low after 3 retries → Fallback message</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">LLM Generation (with citations)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Answer + Documents + Confidence Score</span><br></span></code></pre></div></div>
<p><strong>Latency:</strong> 1-3 seconds (local reranker), 500ms-1s (Cohere rerank).</p>
<p><strong>Tokens:</strong> ~1,141 per query (91% reduction vs file reading).</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="key-design-decisions">Key Design Decisions<a href="#key-design-decisions" class="hash-link" aria-label="Direct link to Key Design Decisions" title="Direct link to Key Design Decisions" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-hybrid-search-bm25--vectors">1. Hybrid Search (BM25 + Vectors)<a href="#1-hybrid-search-bm25--vectors" class="hash-link" aria-label="Direct link to 1. Hybrid Search (BM25 + Vectors)" title="Direct link to 1. Hybrid Search (BM25 + Vectors)" translate="no">​</a></h4>
<ul>
<li class=""><strong>The Problem</strong>: Pure vector search ignores literal matches (config.yaml ≠ “config”), while BM25 can’t catch phrasing or synonyms.</li>
<li class=""><strong>The Approach</strong>: Fuse BM25 + vectors via Reciprocal Rank Fusion (RRF) — no score normalization pain, just precision gains.</li>
<li class=""><strong>Proof</strong>:</li>
</ul>
<table><thead><tr><th>Mode</th><th style="text-align:center">Top-1</th><th style="text-align:center">MRR</th></tr></thead><tbody><tr><td>Hybrid (RRF)</td><td style="text-align:center">82%</td><td style="text-align:center">0.88</td></tr><tr><td>Dense only</td><td style="text-align:center">68%</td><td style="text-align:center">0.74</td></tr><tr><td>BM25 only</td><td style="text-align:center">61%</td><td style="text-align:center">0.69</td></tr></tbody></table>
<p>Hybrid wins everywhere. That’s why it’s the default.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-lazy-hydration-load-code-after-rerank">2. Lazy Hydration (Load Code After Rerank)<a href="#2-lazy-hydration-load-code-after-rerank" class="hash-link" aria-label="Direct link to 2. Lazy Hydration (Load Code After Rerank)" title="Direct link to 2. Lazy Hydration (Load Code After Rerank)" translate="no">​</a></h4>
<ul>
<li class=""><strong>The Problem</strong>: Keeping every code chunk inline in Qdrant explodes storage (≈ 10× more memory).</li>
<li class=""><strong>The Solution</strong>: Store metadata only, then hydrate the top‑K from <code>chunks.jsonl</code> after reranking.</li>
<li class=""><strong>Trade‑off</strong>: Adds ~50 ms of I/O, saves gigabytes of RAM.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-astaware-chunking">3. AST‑Aware Chunking<a href="#3-astaware-chunking" class="hash-link" aria-label="Direct link to 3. AST‑Aware Chunking" title="Direct link to 3. AST‑Aware Chunking" translate="no">​</a></h4>
<ul>
<li class=""><strong>The Problem</strong>: Line-based splits cut functions in half, destroying context.</li>
<li class=""><strong>The Solution</strong>: Parse with tree‑sitter, chunk by function/class, and attach relevant imports.</li>
<li class=""><strong>Result</strong>: Semantically complete chunks → higher retrieval quality, fewer hallucinations.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-selflearning-reranker">4. Self‑Learning Reranker<a href="#4-selflearning-reranker" class="hash-link" aria-label="Direct link to 4. Self‑Learning Reranker" title="Direct link to 4. Self‑Learning Reranker" translate="no">​</a></h4>
<ul>
<li class=""><strong>The Problem</strong>: Pretrained rerankers (e.g., MS MARCO) don’t understand your repo.</li>
<li class=""><strong>The Solution</strong>: Train a cross‑encoder on query logs and golden questions.</li>
<li class=""><strong>Impact</strong>: MRR jumps from 0.72 → 0.88 on the AGRO codebase. It improves the more you use it.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-redisbacked-langgraph-checkpoints">5. Redis‑Backed LangGraph Checkpoints<a href="#5-redisbacked-langgraph-checkpoints" class="hash-link" aria-label="Direct link to 5. Redis‑Backed LangGraph Checkpoints" title="Direct link to 5. Redis‑Backed LangGraph Checkpoints" translate="no">​</a></h4>
<ul>
<li class=""><strong>The Problem</strong>: Stateless pipelines forget context; multi‑turn reasoning is lost.</li>
<li class=""><strong>The Solution</strong>: Redis stores LangGraph checkpoints for conversation memory and resumable chains.</li>
<li class=""><strong>Trade‑off</strong>: Adds one service you likely already run for caching.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-confidence-gating">6. Confidence Gating<a href="#6-confidence-gating" class="hash-link" aria-label="Direct link to 6. Confidence Gating" title="Direct link to 6. Confidence Gating" translate="no">​</a></h4>
<ul>
<li class=""><strong>The Problem</strong>: LLMs hallucinate when retrieval quality dips.</li>
<li class=""><strong>The Solution</strong>: Gate answers on rerank‑based confidence; rewrite query or return a safe fallback when low.</li>
<li class=""><strong>Result</strong>: Zero hallucinated answers across the golden test suite.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="storage-layout">Storage Layout<a href="#storage-layout" class="hash-link" aria-label="Direct link to Storage Layout" title="Direct link to Storage Layout" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">agro-rag-engine/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">├── data/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   ├── {repo}/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   │   ├── chunks.jsonl        # Source-of-truth code chunks</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   │   ├── cards.jsonl         # Semantic summaries</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   │   ├── bm25_index/         # Sparse index</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   │   ├── bm25_cards/         # Card-level index</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   │   ├── queries.jsonl       # Query logs (for reranker training)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   │   └── golden.json         # Golden test suite</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   ├── qdrant/                 # Vector store (Docker volume)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   ├── redis/                  # Redis persistence (optional)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   └── exclude_globs.txt       # Files skipped during indexing</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">├── models/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   └── cross-encoder-agro/     # Custom reranker checkpoint</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│       ├── config.json</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│       ├── model.safetensors</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│       └── tokenizer/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">├── gui/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   ├── index.html              # Web GUI entry</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   ├── js/                     # Front-end modules</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   └── profiles/               # Saved tuning profiles</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">├── server/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   ├── app.py                  # FastAPI endpoints</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   └── langgraph_app.py        # LangGraph pipeline logic</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">├── retrieval/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   ├── hybrid_search.py        # BM25 + Dense fusion</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   ├── ast_chunker.py          # Tree-sitter chunker</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   └── rerank.py               # Cross-encoder reranker</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">├── mcp/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   ├── stdio_server.py         # MCP STDIO transport</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   └── http_server.py          # MCP HTTP transport</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└── infra/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ├── docker-compose.yml      # Infra stack (Qdrant + Redis + Prom + Grafana)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ├── prometheus.yml          # Prometheus config</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ├── grafana/provisioning/   # Prebuilt dashboards</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    └── prometheus-alert-rules.yml</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="infrastructure-containers">Infrastructure Containers<a href="#infrastructure-containers" class="hash-link" aria-label="Direct link to Infrastructure Containers" title="Direct link to Infrastructure Containers" translate="no">​</a></h3>
<ul>
<li class="">qdrant (qdrant/qdrant<!-- -->:v1<!-- -->.15.5) — ports 6333, 6334</li>
<li class="">rag-redis (redis/redis-stack:7.2.0-v10) — port 6379</li>
<li class="">agro-alertmanager (prom/alertmanager<!-- -->:latest<!-- -->) — port 9093</li>
<li class="">agro-prometheus (prom/prometheus<!-- -->:latest<!-- -->) — port 9090</li>
<li class="">agro-loki (grafana/loki<!-- -->:latest<!-- -->) — port 3100</li>
<li class="">agro-promtail (grafana/promtail<!-- -->:latest<!-- -->) — ships logs to Loki</li>
<li class="">agro-grafana (grafana/grafana<!-- -->:latest<!-- -->) — port 3000</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="next-steps">Next Steps<a href="#next-steps" class="hash-link" aria-label="Direct link to Next Steps" title="Direct link to Next Steps" translate="no">​</a></h2>
<ul>
<li class=""><strong><a class="" href="/agro-rag-engine/features/rag">RAG System</a></strong> - Deep dive into hybrid search</li>
<li class=""><strong><a class="" href="/agro-rag-engine/api/endpoints">API Endpoints</a></strong> - HTTP API reference</li>
<li class=""><strong><a class="" href="/agro-rag-engine/operations/deployment">Deployment</a></strong> - Production setup</li>
<li class=""><strong><a class="" href="/agro-rag-engine/operations/troubleshooting">Troubleshooting</a></strong> - Common issues</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/DMontgomery40/agro-rag-engine/tree/main/website/docs/development/architecture.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/agro-rag-engine/development/vscode-setup"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">VS Code Setup</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/agro-rag-engine/operations/deployment"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Deployment</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#system-overview" class="table-of-contents__link toc-highlight">System Overview</a></li><li><a href="#core-components" class="table-of-contents__link toc-highlight">Core Components</a><ul><li><a href="#1-fastapi-server-serverapppy" class="table-of-contents__link toc-highlight">1. FastAPI Server (<code>server/app.py</code>)</a></li><li><a href="#2-langgraph-pipeline-serverlanggraph_apppy" class="table-of-contents__link toc-highlight">2. LangGraph Pipeline (<code>server/langgraph_app.py</code>)</a></li><li><a href="#3-hybrid-search-engine-retrievalhybrid_searchpy" class="table-of-contents__link toc-highlight">3. Hybrid Search Engine (<code>retrieval/hybrid_search.py</code>)</a></li><li><a href="#4-ast-aware-indexer-retrievalast_chunkerpy" class="table-of-contents__link toc-highlight">4. AST-Aware Indexer (<code>retrieval/ast_chunker.py</code>)</a></li><li><a href="#5-vector-database-qdrant" class="table-of-contents__link toc-highlight">5. Vector Database (Qdrant)</a></li><li><a href="#6-bm25-sparse-index-bm25s" class="table-of-contents__link toc-highlight">6. BM25 Sparse Index (<code>bm25s</code>)</a></li><li><a href="#7-self-learning-reranker" class="table-of-contents__link toc-highlight">7. Self-Learning Reranker</a></li><li><a href="#8-semantic-cards" class="table-of-contents__link toc-highlight">8. Semantic Cards</a></li><li><a href="#9-mcp-servers" class="table-of-contents__link toc-highlight">9. MCP Servers</a></li><li><a href="#10-observability-stack" class="table-of-contents__link toc-highlight">10. Observability Stack</a></li></ul></li><li><a href="#data-flow" class="table-of-contents__link toc-highlight">Data Flow</a><ul><li><a href="#indexing-pipeline" class="table-of-contents__link toc-highlight">Indexing Pipeline</a></li><li><a href="#query-pipeline" class="table-of-contents__link toc-highlight">Query Pipeline</a></li><li><a href="#key-design-decisions" class="table-of-contents__link toc-highlight">Key Design Decisions</a></li><li><a href="#storage-layout" class="table-of-contents__link toc-highlight">Storage Layout</a></li><li><a href="#infrastructure-containers" class="table-of-contents__link toc-highlight">Infrastructure Containers</a></li></ul></li><li><a href="#next-steps" class="table-of-contents__link toc-highlight">Next Steps</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/agro-rag-engine/getting-started/quickstart">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/agro-rag-engine/api/reference">API Reference</a></li><li class="footer__item"><a class="footer__link-item" href="/agro-rag-engine/configuration/models">Configuration</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Features</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/agro-rag-engine/features/rag">RAG System</a></li><li class="footer__item"><a class="footer__link-item" href="/agro-rag-engine/features/learning-reranker">Learning Reranker</a></li><li class="footer__item"><a class="footer__link-item" href="/agro-rag-engine/features/mcp">MCP Integration</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/DMontgomery40/agro-rag-engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/agro-rag-engine/development/contributing">Contributing</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 AGRO Project. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>