# CONFIGURATION INTEGRATION COMPLETE AUDIT
## agro_config.json | repos.json | .env
### Full Bidirectional Sync Analysis Across /web

**Date:** 2025-11-21
**Scope:** Every location in /web where config files are read, displayed, or edited

---

## EXECUTIVE SUMMARY

### agro_config.json
- **Total /web Integration Points:** 22 files
- **Backend→Web Auto-Update:** ✅ YES (via `/api/config`)
- **Web→Backend Update:** ✅ YES (via `POST /api/config`)
- **Consistency:** ⚠️ PARTIAL - Modern React components sync, legacy modules require page reload

### repos.json
- **Total /web Integration Points:** 30+ files
- **Backend→Web Auto-Update:** ✅ YES (via `/api/config` and `/api/repos`)
- **Web→Backend Update:** ✅ YES (via `POST /api/config` or `PATCH /api/repos/{name}`)
- **Consistency:** ⚠️ MOSTLY CONSISTENT - One component hardcodes repos, one uses different endpoint

### .env Variables
- **Total Variables Tracked:** 87 unique environment variables
- **Backend→Web Auto-Update:** ⚠️ PARTIAL - Updates on page load/manual refresh only
- **Web→Backend Update:** ✅ YES - All editable vars sync via `/api/env/save`
- **Consistency:** ❌ INCONSISTENT - Many duplicate controls, no auto-polling

---

## 1. agro_config.json INTEGRATION MAP

### Backend Storage & API
| Location | Purpose | Lines |
|----------|---------|-------|
| `/server/services/config_registry.py` | Loads + validates agro_config.json | 65-96 |
| `/server/services/config_store.py` | Merges env + agro_config | 123-210 |
| `/server/routers/config.py` | `GET/POST /api/config` endpoints | 35-58 |

### Frontend State Management
| File | Purpose | Backend→Web | Web→Backend |
|------|---------|-------------|-------------|
| `web/src/stores/useConfigStore.ts` | Zustand global state | ✅ Auto on load | ✅ Via saveConfig() |
| `web/src/api/config.ts` | API client methods | ✅ fetch() | ✅ POST |
| `web/src/api.ts` | Legacy API wrapper | ✅ fetch() | ✅ POST |

### Frontend Components (React/TS) - 14 files
| Component | Config Keys Used | Editable | Sync |
|-----------|------------------|----------|------|
| `Settings/General.tsx` | All env vars | ✅ YES | ✅ YES |
| `Settings/Secrets.tsx` | API keys + custom env | ✅ YES | ✅ YES |
| `Settings/Integrations.tsx` | Integration settings | ✅ YES | ✅ YES |
| `Admin/GeneralSubtab.tsx` | General settings | ✅ YES | ✅ YES |
| `Admin/SecretsSubtab.tsx` | API keys | ✅ YES | ✅ YES |
| `Admin/IntegrationsSubtab.tsx` | Integrations | ✅ YES | ✅ YES |
| `Infrastructure/PathsSubtab.tsx` | Paths config | ✅ YES | ✅ YES |
| `Infrastructure/MCPSubtab.tsx` | MCP settings | ✅ YES | ✅ YES |
| `Chat/ChatInterface.tsx` | Display only | ❌ NO | ❌ NO |
| `Chat/ChatSettings.tsx` | Chat config (separate!) | ✅ YES | ✅ YES |
| `Dashboard/SystemStatusPanel.tsx` | Display only | ❌ NO | ❌ NO |
| `DevTools/Debug.tsx` | Debug settings | ✅ YES | ⚠️ LOCAL |
| `Evaluation/QuestionManager.tsx` | Question repo field | ✅ YES | ✅ YES |
| `KeywordManager.tsx` | Keywords prop | ✅ YES | ✅ YES |

### Legacy JavaScript Modules - 8 files
| Module | Config Access | Editable | Sync |
|--------|---------------|----------|------|
| `modules/config.js` | Direct `/api/config` fetch | ✅ YES | ⚠️ On page reload |
| `modules/app.js` | state.config.env access | ⚠️ PARTIAL | ⚠️ Via POST /api/config |
| `modules/eval_runner.js` | Fetch + save | ✅ YES | ✅ YES |
| `modules/indexing.js` | Fetch only | ❌ NO | ❌ NO |
| `modules/reranker.js` | Fetch only | ❌ NO | ❌ NO |
| `modules/simple_index.js` | Fetch only | ❌ NO | ❌ NO |
| `modules/model_flows.js` | Save only | ✅ YES | ✅ YES |
| `modules/grafana.js` | Read state.config | ❌ NO | ❌ NO |

### **CRITICAL FINDING: Dual Config Systems**
```
MAIN CONFIG:    /api/config → agro_config.json + .env (merged)
CHAT CONFIG:    /api/chat/config → out/chat_config.json (SEPARATE!)
```
⚠️ These are INDEPENDENT systems - do not confuse them!

---

## 2. repos.json INTEGRATION MAP

### Backend Storage & API
| Endpoint | Method | Purpose | File |
|----------|--------|---------|------|
| `/api/repos` | GET | List all repos | routers/repos.py:14 |
| `/api/repos/{name}` | GET | Get single repo | routers/repos.py:20 |
| `/api/repos/{name}` | PATCH | Update repo | routers/repos.py:26 |
| `/api/repos/{name}/validate-path` | POST | Validate path | routers/repos.py:32 |
| `/api/config` | GET | Config with repos array | routers/config.py:35 |
| `/repos/list` | GET | Alt endpoint | ⚠️ CUSTOM |

### Frontend Components with Repo Selectors
| Component | Selector ID | Data Source | Updates |
|-----------|-------------|-------------|---------|
| `Chat/ChatInterface.tsx` | N/A (state) | `/repos/list` ⚠️ | ✅ On load |
| `RAG/IndexingSubtab.tsx` | `#index-repo-select` | state.config | ⚠️ Page reload |
| `RAG/IndexingSubtab.tsx` | `#simple-repo-select` | state.config | ⚠️ Page reload |
| `Admin/GeneralSubtab.tsx` | N/A (state) | useConfigStore | ✅ Auto |
| `DevTools/Debug.tsx` | N/A (hardcoded!) | `['agro', 'test-repo']` | ❌ NEVER |
| `Dashboard/SystemStatusSubtab.tsx` | N/A (state) | Dashboard API | ✅ On refresh |

### Legacy Module Repo Selectors
| Module | Selector ID | Updates |
|--------|-------------|---------|
| `modules/indexing.js` | `#index-repo-select` | ⚠️ On config reload |
| `modules/simple_index.js` | `#simple-repo-select` | ⚠️ On config reload |
| `modules/cards_builder.js` | `#cards-repo-select` | ⚠️ On populateRepoSelect() |
| `modules/chat.js` | `#chat-repo-select` | ⚠️ On config reload |

### **Repo Configuration Editor**
**File:** `web/src/modules/config.js` (Lines 151-435)
- **Full CRUD for repos:** Add/edit/delete keywords per repo
- **Backend Sync:** ✅ YES via `POST /api/config`
- **UI Update:** ⚠️ Requires page reload

### **CRITICAL FINDING: Inconsistent Endpoints**
```
MOST COMPONENTS:    /api/config (gets repos array)
ChatInterface:      /repos/list (custom endpoint - might desync!)
Debug component:    Hardcoded ['agro', 'test-repo'] ❌
```

---

## 3. .env VARIABLES INTEGRATION MAP

### Total Variables: 87 unique environment variables

### Backend API Endpoints
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/config` | GET | Returns merged env + agro_config |
| `/api/env/reload` | POST | Reloads .env from disk |
| `/api/env/save` | POST | Saves env variables to .env file |
| `/api/env/load` | GET | Import from .env file |
| `/api/env/export` | POST | Export to .env file |

### Sync Patterns

#### Pattern 1: Full Bidirectional Sync (BEST)
**Files:** Settings tabs, Admin tabs, Infrastructure tabs

**Flow:**
1. User edits variable in UI
2. Click "Save" button
3. `saveEnv(updates)` → `POST /api/env/save`
4. Backend writes to .env file
5. Store calls `loadConfig()` to refresh
6. UI updates with backend values

**Variables:** 67 variables (see detailed list below)

#### Pattern 2: Read-Only Display
**Files:** Dashboard, legacy modules

**Flow:**
1. Component mounts
2. Fetches `/api/config`
3. Displays values
4. NO save capability

**Variables:** 15 variables

#### Pattern 3: Build-Time Only (NO SYNC)
**File:** `web/src/api/client.ts`

**Variable:** `VITE_API_BASE`
- Set during build
- Cannot be changed at runtime
- Not synced with backend .env

### **CRITICAL FINDING: NO Auto-Polling**
```
Backend changes .env → Web does NOT automatically update

User must:
1. Manually reload page, OR
2. Click "Import from .env" in Settings/Secrets, OR
3. Trigger loadConfig() manually

❌ NO WebSocket or polling mechanism exists
```

### Duplicate Controls (Same Variable, Multiple Locations)
| Variable | Locations | Issue |
|----------|-----------|-------|
| LANGSMITH_API_KEY | Settings/General, Settings/Integrations | Saves twice |
| EDITOR_PORT | Settings/General, Settings/Integrations, Admin/General | 3x controls |
| MCP_HTTP_* | Settings/Integrations, Infrastructure/Paths, Infrastructure/MCP, Admin/General | 4x controls |
| NETLIFY_API_KEY | Settings/General, Admin/General | 2x controls |

⚠️ All duplicate controls work, but user confusion - which one is "real"?

---

## 4. BIDIRECTIONAL SYNC SUMMARY

### agro_config.json

#### Backend → Web
✅ **WORKS via:**
- `GET /api/config` returns merged config
- Zustand store `loadConfig()` fetches on mount
- React components auto-update via store subscription
- Legacy modules update on page reload

⚠️ **LIMITATIONS:**
- No real-time updates (polling/WebSocket)
- Legacy modules require full page reload
- Chat config uses SEPARATE endpoint

#### Web → Backend
✅ **WORKS via:**
- Modern components: `saveConfig()` → `POST /api/config`
- Legacy modules: Direct `POST /api/config`
- Backend validates with Pydantic
- Atomic file writes in config_store.py

⚠️ **LIMITATIONS:**
- .env values OVERRIDE agro_config values
- No optimistic updates (waits for backend response)
- Some forms save entire config, others just env portion

---

### repos.json

#### Backend → Web
✅ **WORKS via:**
- `GET /api/config` includes repos array
- `GET /api/repos` returns all repos
- Zustand store distributes to components
- Dropdowns repopulate on config reload

⚠️ **LIMITATIONS:**
- ChatInterface uses `/repos/list` (different endpoint)
- Debug component hardcodes repos
- Legacy dropdowns don't auto-refresh

#### Web → Backend
✅ **WORKS via:**
- `POST /api/config` saves full config with repos
- `PATCH /api/repos/{name}` updates single repo
- Keyword manager in config.js saves via `/api/config`

⚠️ **LIMITATIONS:**
- No real-time sync between tabs
- Repo editor requires page reload to see changes
- No validation of duplicate repo names client-side

---

### .env Variables

#### Backend → Web
⚠️ **PARTIAL - Only on explicit load:**
- Initial page load: `loadConfig()` fetches all env vars
- Manual reload: User clicks "Import from .env"
- After save: Store calls `loadConfig()` to verify

❌ **DOES NOT WORK:**
- Backend changes .env → Web doesn't know
- No polling or WebSocket
- No file watcher on frontend

#### Web → Backend
✅ **WORKS via:**
- All editable forms: `saveEnv()` → `POST /api/env/save`
- Backend writes to .env file
- Backend reloads .env after write
- Config registry picks up changes

✅ **SPECIAL FEATURES:**
- Import/Export .env file (Settings/Secrets, Admin/Secrets)
- File upload for bulk import
- Masked values for secrets

⚠️ **LIMITATIONS:**
- Duplicate controls save same values multiple times
- No conflict resolution if multiple users edit
- Boolean values inconsistent (0/1 vs true/false vs "1"/"0")

---

## 5. FILES WITH CONFIG REFERENCES (COMPLETE LIST)

### Backend (7 files)
1. `server/models/agro_config_model.py` - Pydantic models
2. `server/services/config_registry.py` - Config loader
3. `server/services/config_store.py` - File I/O + merging
4. `server/routers/config.py` - Config API endpoints
5. `server/routers/repos.py` - Repos API endpoints
6. `server/routers/chat.py` - Chat config endpoint (SEPARATE)
7. `server/routers/env.py` - Env management endpoints

### Frontend Types/API (5 files)
1. `web/src/types/index.ts` - TypeScript interfaces
2. `web/src/api/config.ts` - Config API client
3. `web/src/api/dashboard.ts` - Dashboard API + types
4. `web/src/api.ts` - Legacy API wrapper
5. `web/src/api/client.ts` - HTTP client (VITE_API_BASE)

### Frontend State (2 files)
1. `web/src/stores/useConfigStore.ts` - Zustand global state
2. `web/src/hooks/useTooltips.ts` - Tooltip documentation

### Frontend Services (3 files)
1. `web/src/services/IndexingService.ts` - Index stats
2. `web/src/services/RAGService.ts` - RAG operations
3. `web/src/services/IndexProfilesService.ts` - Profile management

### Frontend Components - React/TS (18 files)
1. `web/src/components/Settings/General.tsx`
2. `web/src/components/Settings/Secrets.tsx`
3. `web/src/components/Settings/Integrations.tsx`
4. `web/src/components/Admin/GeneralSubtab.tsx`
5. `web/src/components/Admin/SecretsSubtab.tsx`
6. `web/src/components/Admin/IntegrationsSubtab.tsx`
7. `web/src/components/Admin/GitIntegrationSubtab.tsx`
8. `web/src/components/Infrastructure/PathsSubtab.tsx`
9. `web/src/components/Infrastructure/MCPSubtab.tsx`
10. `web/src/components/Infrastructure/ServicesSubtab.tsx`
11. `web/src/components/Chat/ChatInterface.tsx`
12. `web/src/components/Chat/ChatSettings.tsx`
13. `web/src/components/Dashboard/SystemStatusSubtab.tsx`
14. `web/src/components/Dashboard/SystemStatusPanel.tsx`
15. `web/src/components/DevTools/Debug.tsx`
16. `web/src/components/Evaluation/QuestionManager.tsx`
17. `web/src/components/KeywordManager.tsx`
18. `web/src/components/RAG/IndexingSubtab.tsx`

### Frontend Components - Legacy JS (11 files)
1. `web/src/modules/config.js` - **MAIN CONFIG EDITOR**
2. `web/src/modules/app.js`
3. `web/src/modules/eval_runner.js`
4. `web/src/modules/indexing.js`
5. `web/src/modules/reranker.js`
6. `web/src/modules/simple_index.js`
7. `web/src/modules/model_flows.js`
8. `web/src/modules/grafana.js`
9. `web/src/modules/editor.js`
10. `web/src/modules/editor-settings.js`
11. `web/src/modules/cards_builder.js`
12. `web/src/modules/chat.js`
13. `web/src/modules/golden_questions.js`
14. `web/src/modules/mcp_rag.js`
15. `web/src/modules/trace.js`

### Frontend App Entry (2 files)
1. `web/src/App.tsx` - Loads legacy modules
2. `web/src/main.tsx` - Vite entry point

---

## 6. CRITICAL ISSUES FOUND

### Issue 1: No Real-Time Backend→Web Updates
**Problem:** If backend changes .env or agro_config.json directly (e.g., via CLI), web doesn't know

**Impact:** User sees stale data until manual refresh

**Fix Needed:** Add polling or WebSocket for config changes

### Issue 2: Duplicate Controls
**Problem:** Same variable editable in 3-4 different places

**Examples:**
- MCP_HTTP_* in 4 locations
- EDITOR_PORT in 3 locations
- LANGSMITH_API_KEY in 2 locations

**Impact:** User confusion, inconsistent UX

**Fix Needed:** Consolidate or clearly label primary vs. shortcut controls

### Issue 3: Inconsistent Repo Endpoints
**Problem:** Most components use `/api/config`, ChatInterface uses `/repos/list`

**Impact:** Potential desync if one endpoint doesn't reflect latest changes

**Fix Needed:** Standardize on single endpoint or ensure both stay in sync

### Issue 4: Debug Component Hardcodes Repos
**File:** `web/src/components/DevTools/Debug.tsx`
```typescript
const [repositories, setRepositories] = useState(['agro', 'test-repo']);
```

**Problem:** Never updates from backend, always shows fake data

**Fix Needed:** Fetch from `/api/repos` instead

### Issue 5: Legacy Modules Need Page Reload
**Problem:** Changes made via modern React components don't update legacy module state

**Impact:** User sees correct data in one tab, stale data in legacy sections

**Fix Needed:** Either migrate legacy modules to React or add event bus for cross-system sync

### Issue 6: Chat Config Confusion
**Problem:** `/api/chat/config` returns DIFFERENT config than `/api/config`

**Files:** `out/chat_config.json` vs `agro_config.json`

**Impact:** User edits "config" but doesn't know there are TWO config systems

**Fix Needed:** Better documentation or merge into single config

---

## 7. RECOMMENDATIONS

### High Priority
1. **Add real-time config updates** via polling or WebSocket
2. **Consolidate duplicate controls** - pick one primary location per variable
3. **Fix Debug component** to fetch real repos, not hardcoded list
4. **Standardize repo endpoints** - deprecate `/repos/list` or ensure consistency
5. **Document chat config separation** - make it clear these are different systems

### Medium Priority
1. **Migrate legacy modules to React** for consistent state management
2. **Add optimistic updates** for better UX (show change immediately, revert on error)
3. **Type safety** - ensure all config TypeScript types match backend Pydantic models
4. **Validation** - client-side validation before sending to backend

### Low Priority
1. **Conflict detection** - warn if multiple users edit same config simultaneously
2. **Change history** - track who changed what and when
3. **Rollback capability** - restore previous config versions

---

## 8. VERIFICATION CHECKLIST

To verify config sync is working:

### For agro_config.json:
- [ ] Edit in Settings/General → Check backend file changes
- [ ] Edit in Admin/General → Check both locations match
- [ ] Edit backend file → Reload page → Check UI reflects change
- [ ] Edit via legacy config.js → Check modern components update (needs reload)

### For repos.json:
- [ ] Add repo in config.js editor → Check file updates
- [ ] Edit via `PATCH /api/repos/{name}` → Check all dropdowns update
- [ ] Edit backend file → Check all 8+ dropdown selectors refresh
- [ ] Verify Debug component shows real repos (CURRENTLY BROKEN)

### For .env:
- [ ] Edit any of 87 variables in UI → Check .env file updates
- [ ] Edit .env file directly → Click "Import" → Check UI reflects change
- [ ] Save in Settings/General → Check Admin/General shows same value
- [ ] Save in one of 4 MCP controls → Check all 4 locations match

---

## 9. CONCLUSION

**OVERALL STATUS:** ⚠️ MOSTLY WORKING BUT NEEDS IMPROVEMENT

**What Works Well:**
- Modern React components sync bidirectionally via Zustand store
- Backend API endpoints are well-structured with validation
- Save operations correctly write to disk with atomic guarantees

**What Needs Fixing:**
- No real-time updates (backend changes don't push to web)
- Duplicate controls cause confusion
- Legacy modules create sync lag
- One component hardcodes data
- Two separate config systems (main + chat) lack clear documentation

**Estimated Effort to Fix:**
- High priority issues: 2-3 days
- Medium priority issues: 1 week
- Full modernization: 2-3 weeks

**Immediate Next Steps:**
1. Fix Debug component hardcoded repos (15 min)
2. Add config change polling (2 hours)
3. Document chat config separation (1 hour)
4. Consolidate duplicate MCP controls (3 hours)
